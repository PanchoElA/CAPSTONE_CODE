<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Generador QR - Sistema REP</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .form-group { margin-bottom: 16px; }
      .form-group label { display: block; margin-bottom: 4px; font-weight: bold; }
      .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
      .qr-result { margin-top: 20px; padding: 16px; background: #f0f8ff; border: 1px solid #0366d6; border-radius: 6px; }
      .qr-code { font-family: monospace; font-size: 18px; font-weight: bold; color: #0366d6; }
    </style>
  </head>
  <body>
    <header>
      <h1>Generador QR - Sistema REP</h1>
      <div class="actions">
        <a class="btn" href="/">Dashboard</a>
        <a class="btn" href="/reportes">Reportes</a>
      </div>
    </header>
    <main>
      <section class="box">
        <h2>Generar QR Único</h2>
        <form id="qrForm">
          <div class="form-group">
            <label for="tipo_qr">Tipo de QR:</label>
            <select id="tipo_qr" name="tipo_qr" required>
              <option value="CODELPA">CODELPA (Balde propio para reuso)</option>
              <option value="TERCERO">TERCERO (Balde externo para valorización)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="marca_envase">Marca del Envase:</label>
            <input type="text" id="marca_envase" name="marca_envase" placeholder="ej. CODELPA, SHERWIN, ANYPSA">
          </div>
          
          <div class="form-group">
            <label for="peso_envase_kg">Peso del Envase (kg):</label>
            <input type="number" id="peso_envase_kg" name="peso_envase_kg" step="0.1" value="0.5" min="0">
          </div>
          
          <div class="form-group">
            <label for="lote_produccion">Lote de Producción:</label>
            <input type="text" id="lote_produccion" name="lote_produccion" placeholder="ej. LOTE_2024_10_001">
          </div>
          
          <button type="submit" class="btn primary">Generar QR</button>
        </form>
        
        <div id="qrResult" class="qr-result" style="display: none;">
          <h3>QR Generado:</h3>
          <div class="qr-code" id="qrCode"></div>
          <p><strong>Tipo:</strong> <span id="resultTipo"></span></p>
          <p><strong>Marca:</strong> <span id="resultMarca"></span></p>
          <p><strong>Peso:</strong> <span id="resultPeso"></span> kg</p>
        </div>
      </section>
    </main>
    
    <script>
      document.getElementById('qrForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Auto-completar marca según tipo
        if (!data.marca_envase) {
          data.marca_envase = data.tipo_qr === 'CODELPA' ? 'CODELPA' : 'TERCERO';
        }
        
        try {
          const response = await fetch('/generate_qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.qr_id) {
            document.getElementById('qrCode').textContent = result.qr_id;
            document.getElementById('resultTipo').textContent = result.tipo_qr;
            document.getElementById('resultMarca').textContent = result.marca_envase;
            document.getElementById('resultPeso').textContent = result.peso_envase_kg;
            document.getElementById('qrResult').style.display = 'block';
          } else {
            alert('Error: ' + (result.error || 'No se pudo generar QR'));
          }
        } catch (err) {
          alert('Error de conexión: ' + err.message);
        }
      });
    </script>
  </body>
</html>